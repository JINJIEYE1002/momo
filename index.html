<!DOCTYPE html>
<html lang="zh-HK">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MoMo Finance Journey | æ¯›æ¯›ç†è²¡ä¹‹æ—…</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: #2d3748;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      /* ç™»éŒ„é é¢æ¨£å¼ */
      .login-container {
        max-width: 480px;
        margin: 40px auto;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 50px 40px;
        border-radius: 24px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .logo-section {
        margin-bottom: 40px;
      }

      .momo-character {
        font-size: 4em;
        margin-bottom: 15px;
        animation: bounce 2s infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .logo-section h1 {
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 2.2em;
        font-weight: 700;
      }

      .tagline {
        color: #718096;
        font-size: 1.1em;
        font-weight: 500;
      }

      .login-form {
        margin-bottom: 30px;
      }

      .input-group {
        margin-bottom: 25px;
        text-align: left;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        color: #2d3748;
        font-weight: 600;
        font-size: 0.95em;
      }

      .input-group input {
        width: 100%;
        padding: 15px 20px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
      }

      .input-group input:focus {
        border-color: #667eea;
        outline: none;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        transform: translateY(-2px);
      }

      .primary-btn {
        width: 100%;
        padding: 18px;
        background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
        color: white;
        border: none;
        border-radius: 16px;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
      }

      .primary-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(255, 107, 107, 0.4);
      }

      .btn-icon {
        font-size: 1.2em;
      }

      /* éŠæˆ²é é¢æ¨£å¼ */
      .game-header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 20px 30px;
        border-radius: 20px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .player-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .player-avatar {
        font-size: 2.5em;
      }

      .player-details {
        flex: 1;
      }

      .player-details h2 {
        color: #2d3748;
        margin-bottom: 4px;
        font-size: 1.4em;
      }

      .player-details p {
        color: #718096;
        font-size: 0.9em;
      }

      .game-controls {
        text-align: center;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .progress-info {
        background: rgba(255, 255, 255, 0.9);
        padding: 12px 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .location {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 5px;
        font-size: 1em;
      }

      .total-assets {
        font-weight: 700;
        color: #d63031;
        font-size: 1.3em;
      }

      .savings-info {
        font-weight: 600;
        color: #2d3748;
        font-size: 1em;
      }

      .day-info {
        font-weight: 600;
        color: #2d3748;
        font-size: 1em;
      }

      /* éŠæˆ²åœ°åœ–æ¨£å¼ */
      .game-board {
        background: rgba(255, 255, 255, 0.95);
        padding: 20px;
        border-radius: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        min-height: 600px;
        position: relative;
      }

      .map-container {
        position: relative;
        width: 100%;
        height: 550px;
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border-radius: 16px;
        overflow: hidden;
        border: 3px solid #90caf9;
      }

      .railway-map {
        position: relative;
        width: 100%;
        height: 100%;
      }

      /* éµè·¯ç·šè·¯æ¨£å¼ */
      .rail-lines {
        position: absolute;
        width: 100%;
        height: 100%;
      }

      .rail-line {
        position: absolute;
        height: 8px;
        transform-origin: 0 0;
        z-index: 1;
      }

      /* è»Šç«™æ¨™è¨˜æ¨£å¼ */
      .stations {
        position: absolute;
        width: 100%;
        height: 100%;
      }

      .station-marker {
        position: absolute;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
        transition: all 0.3s ease;
      }

      .station-dot {
        width: 24px;
        height: 24px;
        background: #333;
        border-radius: 50%;
        margin: 0 auto 3px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        border: 3px solid white;
        transition: all 0.3s ease;
      }

      .station-name {
        font-size: 8px;
        font-weight: 600;
        color: #333;
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 4px;
        border-radius: 6px;
        white-space: nowrap;
      }

      /* ===== ç©å®¶è³‡è¨Šé¢æ¿æ¨£å¼ ===== */
      .player-info-section {
        padding: 15px;
        background: rgba(255, 255, 255, 0.98);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 12px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        background: rgba(247, 250, 252, 0.8);
        border-radius: 8px;
        font-size: 0.95em;
        transition: all 0.3s ease;
      }

      .info-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .info-label {
        color: #4a5568;
        font-weight: 600;
      }

      .info-value {
        color: #2d3748;
        font-weight: 700;
      }

      /* ç•¶å‰è»Šç«™æ¨£å¼ */
      .station-marker.current .station-dot {
        background: #ff6b6b;
        border-color: #fff;
        box-shadow: 0 0 15px rgba(255, 107, 107, 0.8);
        animation: pulse 2s infinite;
        transform: scale(1.2);
      }

      @keyframes pulse {
        0% {
          transform: scale(1.2);
        }
        50% {
          transform: scale(1.5);
        }
        100% {
          transform: scale(1.2);
        }
      }

      /* ç©å®¶åœ–æ¨™æ¨£å¼ */
      .player-icon {
        position: absolute;
        font-size: 24px;
        transform: translate(-50%, -50%);
        z-index: 1000;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        transition: all 1s ease-in-out;
        display: none;
      }

      /* æ“ä½œæŒ‰éˆ•çµ„æ¨£å¼ */
      .simple-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
      }

      .action-btn {
        padding: 15px;
        background: linear-gradient(135deg, #a8e6cf, #88d4ab);
        color: #2d3748;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(168, 230, 207, 0.3);
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(168, 230, 207, 0.4);
      }

      .action-btn.secondary {
        background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
      }

      /* äº‹ä»¶å½ˆçª—æ¨£å¼ */
      .event-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }

      .event-modal.active {
        display: flex;
      }

      .event-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      }

      .event-emoji {
        font-size: 4em;
        margin-bottom: 20px;
      }

      .event-title {
        font-size: 1.5em;
        font-weight: 700;
        margin-bottom: 15px;
        color: #2d3748;
      }

      .event-message {
        margin-bottom: 25px;
        line-height: 1.6;
        color: #4a5568;
      }

      .event-choices {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-direction: column;
      }

      .choice-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .choice-btn.primary {
        background: #48bb78;
        color: white;
      }

      .choice-btn.secondary {
        background: #e53e3e;
        color: white;
      }

      .choice-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }

        .login-container {
          margin: 20px auto;
          padding: 30px 25px;
        }

        .game-header {
          flex-direction: column;
          gap: 20px;
          text-align: center;
        }

        .player-info {
          justify-content: center;
        }

        .game-board {
          min-height: 500px;
          padding: 20px;
        }

        .map-container {
          height: 450px;
        }

        .station-dot {
          width: 20px;
          height: 20px;
        }

        .station-name {
          font-size: 7px;
        }
      }

      @media (max-width: 480px) {
        .login-container {
          margin: 10px auto;
          padding: 25px 20px;
        }

        .momo-character {
          font-size: 3em;
        }

        .logo-section h1 {
          font-size: 1.8em;
        }

        .game-board {
          min-height: 400px;
          padding: 15px;
        }

        .map-container {
          height: 350px;
        }

        .station-dot {
          width: 16px;
          height: 16px;
        }

        .station-name {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- ç™»éŒ„ç•Œé¢ -->
      <div id="login-page" class="page active">
        <div class="login-container">
          <div class="logo-section">
            <div class="momo-character">ğŸ±</div>
            <h1>MoMo Finance Journey<br />æ¯›æ¯›ç†è²¡ä¹‹æ—…</h1>
            <p class="tagline">Learn Financial Skills â€¢ å­¸ç¿’ç†è²¡æŠ€èƒ½</p>
          </div>
          <div class="login-form">
            <div class="input-group">
              <label for="studentId">Student ID å­¸ç”ŸID</label>
              <input
                type="text"
                id="studentId"
                placeholder="Enter your student ID è¼¸å…¥å­¸ç”ŸID"
                required
              />
            </div>
            <div class="input-group">
              <label for="playerNickname">Nickname æš±ç¨±</label>
              <input
                type="text"
                id="playerNickname"
                placeholder="Choose a nickname é¸æ“‡æš±ç¨±"
                required
              />
            </div>
            <button id="startGameBtn" class="primary-btn">
              <span class="btn-icon">ğŸš€</span>
              é–‹å§‹éŠæˆ² Start Game
            </button>
          </div>
        </div>
      </div>

      <!-- éŠæˆ²ä¸»ç•Œé¢ -->
      <div id="game-page" class="page">
        <div class="game-header">
          <div class="player-info">
            <div class="player-avatar">ğŸ±</div>
            <div class="player-details">
              <h2 id="displayNickname">Player</h2>
              <p>ID: <span id="displayStudentId">-</span></p>
              <!-- ç©å®¶è³‡è¨Šé¢æ¿ -->
              <div class="player-info-section">
                <div class="info-grid">
                  <div class="info-item">
                    <span class="info-label">ğŸ“Š ç•¶å‰è³‡ç”¢ï¼š</span>
                    <span class="info-value" id="infoTotalAssets">$1,000</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">ğŸ“… éŠæˆ²å¤©æ•¸ï¼š</span>
                    <span class="info-value" id="infoCurrentDay">ç¬¬ 1 å¤©</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">ğŸš‰ ç•¶å‰è»Šç«™ï¼š</span>
                    <span class="info-value" id="infoCurrentStation">-</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">ğŸ’¹ ç‰©åƒ¹æŒ‡æ•¸ï¼š</span>
                    <span class="info-value" id="infoPriceIndex">1.000</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">ğŸ’° ä»Šæ—¥å„²è“„ï¼š</span>
                    <span class="info-value" id="infoDailySavings">$1</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">ğŸ‰ ç´¯ç©ç²å¾—ï¼š</span>
                    <span class="info-value" id="infoCumulativeGains">$0</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">ğŸ“ˆ ç¸½æŠ•è³‡ï¼š</span>
                    <span class="info-value" id="infoTotalInvestment">$0</span>
                  </div>
                  <div class="info-item">
                    <span class="info-label">ğŸ¦ ç´¯ç©å„²è“„ï¼š</span>
                    <span class="info-value" id="infoTotalSavings">$0</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="game-controls">
            <div class="control-group">
              <button id="nextDayBtn" class="primary-btn">
                <span class="btn-icon">â­ï¸</span>
                <span class="btn-text">ä¸‹ä¸€å¤© Next Day</span>
              </button>
              <div class="progress-info">
                <div class="day-info">
                  ğŸ“… ç¬¬ <span id="currentDay">1</span> å¤© |
                  <span id="currentDate">2025-10-12 æ˜ŸæœŸæ—¥</span>
                </div>
                <div class="location">
                  ğŸ“ <span id="currentStation">-</span>
                </div>
                <div class="total-assets">
                  ğŸ’° ç¸½è³‡ç”¢ï¼š$<span id="totalAssets">1,000</span>
                </div>
                <div class="savings-info">
                  ğŸ’¾ ä»Šæ—¥å„²è“„ï¼š$<span id="dailySavings">1</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="game-board">
          <div class="map-container">
            <div class="railway-map" id="railway-map">
              <!-- éµè·¯ç·šè·¯å’Œè»Šç«™å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
            </div>
            <div class="player-icon" id="player-icon">ğŸ±</div>
          </div>
        </div>

        <div class="simple-actions">
          <button id="newGameBtn" class="action-btn secondary">
            <span class="btn-icon">ğŸ”„</span>
            é‡æ–°éŠæˆ² Restart
          </button>
        </div>
      </div>
    </div>

    <!-- äº‹ä»¶å½ˆçª— -->
    <div id="eventModal" class="event-modal">
      <div class="event-content">
        <div class="event-emoji" id="eventEmoji">ğŸ¯</div>
        <h3 class="event-title" id="eventTitle">äº‹ä»¶æ¨™é¡Œ</h3>
        <p class="event-message" id="eventMessage">äº‹ä»¶æè¿°å…§å®¹...</p>
        <div class="event-choices" id="eventChoices">
          <!-- é¸æ“‡æŒ‰éˆ•å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
        </div>
      </div>
    </div>

    <script>
      // éŠæˆ²æ•¸æ“š
      const gameBoard = {
        // åœ°éµç·šè·¯é¡è‰²å°ç…§è¡¨
        lineColors: {
          twl: "#e60012", // èƒç£ç·š ç´…è‰²
          tw: "#880022", // å±¯é¦¬ç·š é…’ç´…è‰²
          ktl: "#009944", // è§€å¡˜ç·š ç¶ è‰²
          erl: "#0072bc", // æ±éµç·š è—è‰²
          il: "#003d79", // æ¸¯å³¶ç·š è—é’è‰²
          tkl: "#a864a8", // å°‡è»æ¾³ç·š ç´«è‰²
          tcl: "#f8a800", // æ±æ¶Œç·š æ©™è‰²
        },

        // è»Šç«™æ•¸æ“š
        stations: {
          // === å±¯é¦¬ç·š ===
          "Tuen Mun å±¯é–€": { x: 2, y: 30, line: "tw" },
          "Siu Hong å…†åº·": { x: 2, y: 20, line: "tw" },
          "Tin Shui Wai å¤©æ°´åœ": { x: 2, y: 10, line: "tw" },
          "Long Ping æœ—å±": { x: 7, y: 10, line: "tw" },
          "Yuen Long å…ƒæœ—": { x: 15, y: 10, line: "tw" },
          "Kam Sheung Road éŒ¦ä¸Šè·¯": { x: 15, y: 10, line: "tw" },
          "Tsuen Wan West èƒç£è¥¿": { x: 25, y: 15, line: "tw" },
          "Mei Foo ç¾å­š": { x: 30, y: 35, line: "tw" },
          "Nam Cheong å—æ˜Œ": { x: 35, y: 40, line: "tw" },
          "Austin æŸ¯å£«ç”¸": { x: 40, y: 60, line: "tw" },
          "East Tsim Sha Tsui å°–æ±": { x: 50, y: 75, line: "tw" },
          "Hung Hom ç´…ç£¡": { x: 60, y: 65, line: "tw" },
          "Ho Man Tin ä½•æ–‡ç”°": { x: 65, y: 60, line: "tw" },
          "Sung Wong Toi å®‹çš‡è‡º": { x: 75, y: 50, line: "tw" },
          "To Kwa Wan åœŸç“œç£": { x: 80, y: 40, line: "tw" },
          "Kai Tak å•Ÿå¾·": { x: 85, y: 30, line: "tw" },
          "Diamond Hill é‘½çŸ³å±±": { x: 80, y: 30, line: "tw" },
          "Hin Keng é¡¯å¾‘": { x: 60, y: 25, line: "tw" },
          "Tai Wai å¤§åœ": { x: 55, y: 20, line: "tw" },
          "Che Kung Temple è»Šå…¬å»Ÿ": { x: 70, y: 20, line: "tw" },
          "Sha Tin Wai æ²™ç”°åœ": { x: 75, y: 20, line: "tw" },
          "City One ç¬¬ä¸€åŸ": { x: 80, y: 20, line: "tw" },
          "Shek Mun çŸ³é–€": { x: 85, y: 15, line: "tw" },
          "Tai Shui Hang å¤§æ°´å‘": { x: 85, y: 10, line: "tw" },
          "Heng On æ’å®‰": { x: 85, y: 5, line: "tw" },
          "Ma On Shan é¦¬éå±±": { x: 90, y: 5, line: "tw" },
          "Wu Kai Sha çƒæºªæ²™": { x: 95, y: 5, line: "tw" },

          // === æ±æ¶Œç·š ===
          "Tung Chung æ±æ¶Œ": { x: 10, y: 80, line: "tcl" },
          "Sunny Bay æ¬£æ¾³": { x: 15, y: 70, line: "tcl" },
          "Tsing Yi é’è¡£": { x: 20, y: 45, line: "tcl" },
          "Lai King è”æ™¯": { x: 25, y: 35, line: "tcl" },
          "Nam Cheong å—æ˜Œ": { x: 35, y: 45, line: "tcl" },
          "Olympic å¥§é‹": { x: 35, y: 55, line: "tcl" },
          "Kowloon ä¹é¾": { x: 35, y: 65, line: "tcl" },
          "Hong Kong é¦™æ¸¯": { x: 30, y: 80, line: "tcl" },

          // === èƒç£ç·š ===
          "Tsuen Wan èƒç£": { x: 8, y: 25, line: "twl" },
          "Tai Wo Hau å¤§çª©å£": { x: 15, y: 25, line: "twl" },
          "Kwai Hing è‘µèˆˆ": { x: 20, y: 25, line: "twl" },
          "Kwai Fong è‘µèŠ³": { x: 25, y: 25, line: "twl" },
          "Lai King è”æ™¯": { x: 25, y: 35, line: "twl" },
          "Mei Foo ç¾å­š": { x: 30, y: 35, line: "twl" },
          "Lai Chi Kok è”æè§’": { x: 38, y: 35, line: "twl" },
          "Cheung Sha Wan é•·æ²™ç£": { x: 43, y: 35, line: "twl" },
          "Sham Shui Po æ·±æ°´åŸ—": { x: 48, y: 35, line: "twl" },
          "Prince Edward å¤ªå­": { x: 53, y: 35, line: "twl" },
          "Mong Kok æ—ºè§’": { x: 53, y: 45, line: "twl" },
          "Yau Ma Tei æ²¹éº»åœ°": { x: 53, y: 55, line: "twl" },
          "Jordan ä½æ•¦": { x: 48, y: 65, line: "twl" },
          "Tsim Sha Tsui å°–æ²™å’€": { x: 43, y: 75, line: "twl" },
          "Admiralty é‡‘é˜": { x: 35, y: 85, line: "twl" },
          "Central ä¸­ç’°": { x: 30, y: 85, line: "twl" },

          // === æ¸¯å³¶ç·š ===
          "Kennedy Town å …å°¼åœ°åŸ": { x: 5, y: 93, line: "il" },
          "HKU é¦™æ¸¯å¤§å­¸": { x: 10, y: 90, line: "il" },
          "Sai Ying Pun è¥¿ç‡Ÿç›¤": { x: 15, y: 85, line: "il" },
          "Sheung Wan ä¸Šç’°": { x: 20, y: 85, line: "il" },
          "Central ä¸­ç’°": { x: 30, y: 85, line: "il" },
          "Admiralty é‡‘é˜": { x: 35, y: 85, line: "il" },
          "Wan Chai ç£ä»”": { x: 40, y: 85, line: "il" },
          "Causeway Bay éŠ…é‘¼ç£": { x: 45, y: 85, line: "il" },
          "Tin Hau å¤©å": { x: 50, y: 85, line: "il" },
          "Fortress Hill ç‚®å°å±±": { x: 55, y: 85, line: "il" },
          "North Point åŒ—è§’": { x: 65, y: 85, line: "il" },
          "Quarry Bay é°‚é­šæ¶Œ": { x: 70, y: 85, line: "il" },
          "Tai Koo å¤ªå¤": { x: 75, y: 85, line: "il" },
          "Sai Wan Ho è¥¿ç£æ²³": { x: 80, y: 85, line: "il" },
          "Shau Kei Wan ç­²ç®•ç£": { x: 85, y: 85, line: "il" },
          "Heng Fa Chuen æèŠ±é‚¨": { x: 90, y: 90, line: "il" },
          "Chai Wan æŸ´ç£": { x: 95, y: 95, line: "il" },

          // === æ±éµç·š ===
          "Lok Ma Chau è½é¦¬æ´²": { x: 25, y: 5, line: "erl" },
          "Sheung Shui ä¸Šæ°´": { x: 30, y: 5, line: "erl" },
          "Fanling ç²‰å¶º": { x: 35, y: 5, line: "erl" },
          "Tai Wo å¤ªå’Œ": { x: 40, y: 5, line: "erl" },
          "Tai Po Market å¤§åŸ”å¢Ÿ": { x: 45, y: 5, line: "erl" },
          "University å¤§å­¸": { x: 50, y: 5, line: "erl" },
          "Fo Tan ç«ç‚­": { x: 55, y: 10, line: "erl" },
          "Sha Tin æ²™ç”°": { x: 55, y: 15, line: "erl" },
          "Tai Wai å¤§åœ": { x: 55, y: 20, line: "erl" },
          "Kowloon Tong ä¹é¾å¡˜": { x: 60, y: 30, line: "erl" },
          "Mong Kok East æ—ºè§’æ±": { x: 60, y: 45, line: "erl" },
          "Hung Hom ç´…ç£¡": { x: 60, y: 65, line: "erl" },
          "Exhibition Centre æœƒå±•": { x: 50, y: 80, line: "erl" },
          "Admiralty é‡‘é˜": { x: 35, y: 85, line: "erl" },

          // === è§€å¡˜ç·š ===
          "Whampoa é»ƒåŸ”": { x: 70, y: 70, line: "ktl" },
          "Ho Man Tin ä½•æ–‡ç”°": { x: 65, y: 60, line: "ktl" },
          "Yau Ma Tei æ²¹éº»åœ°": { x: 53, y: 55, line: "ktl" },
          "Mong Kok æ—ºè§’": { x: 53, y: 45, line: "ktl" },
          "Prince Edward å¤ªå­": { x: 53, y: 35, line: "ktl" },
          "Shek Kip Mei çŸ³ç¡¤å°¾": { x: 55, y: 30, line: "ktl" },
          "Kowloon Tong ä¹é¾å¡˜": { x: 60, y: 30, line: "ktl" },
          "Lok Fu æ¨‚å¯Œ": { x: 70, y: 30, line: "ktl" },
          "Wong Tai Sin é»ƒå¤§ä»™": { x: 75, y: 30, line: "ktl" },
          "Diamond Hill é‘½çŸ³å±±": { x: 80, y: 30, line: "ktl" },
          "Choi Hung å½©è™¹": { x: 85, y: 30, line: "ktl" },
          "Kowloon Bay ä¹é¾ç£": { x: 90, y: 35, line: "ktl" },
          "Ngau Tau Kok ç‰›é ­è§’": { x: 90, y: 45, line: "ktl" },
          "Kwun Tong è§€å¡˜": { x: 90, y: 55, line: "ktl" },
          "Lam Tin è—ç”°": { x: 90, y: 65, line: "ktl" },
          "Yau Tong æ²¹å¡˜": { x: 90, y: 75, line: "ktl" },
          "Tiu Keng Leng èª¿æ™¯å¶º": { x: 90, y: 75, line: "ktl" },

          // === å°‡è»æ¾³ç·š ===
          "North Point åŒ—è§’": { x: 65, y: 85, line: "tkl" },
          "Quarry Bay é°‚é­šæ¶Œ": { x: 70, y: 85, line: "tkl" },
          "Yau Tong æ²¹å¡˜": { x: 90, y: 75, line: "tkl" },
          "Tiu Keng Leng èª¿æ™¯å¶º": { x: 90, y: 75, line: "tkl" },
          "Tseung Kwan O å°‡è»æ¾³": { x: 95, y: 75, line: "tkl" },
          "Hang Hau å‘å£": { x: 95, y: 65, line: "tkl" },
          "Po Lam å¯¶ç³": { x: 95, y: 55, line: "tkl" },
          "LOHAS Park åº·åŸ": { x: 95, y: 50, line: "tkl" },
        },

        // ç·šè·¯é€£æ¥é—œä¿‚
        connections: [
          // å±¯é¦¬ç·š
          { from: "Tuen Mun å±¯é–€", to: "Siu Hong å…†åº·", line: "tw" },
          { from: "Siu Hong å…†åº·", to: "Tin Shui Wai å¤©æ°´åœ", line: "tw" },
          { from: "Tin Shui Wai å¤©æ°´åœ", to: "Long Ping æœ—å±", line: "tw" },
          { from: "Long Ping æœ—å±", to: "Yuen Long å…ƒæœ—", line: "tw" },
          { from: "Yuen Long å…ƒæœ—", to: "Kam Sheung Road éŒ¦ä¸Šè·¯", line: "tw" },
          {
            from: "Kam Sheung Road éŒ¦ä¸Šè·¯",
            to: "Tsuen Wan West èƒç£è¥¿",
            line: "tw",
          },
          { from: "Tsuen Wan West èƒç£è¥¿", to: "Mei Foo ç¾å­š", line: "tw" },
          { from: "Mei Foo ç¾å­š", to: "Nam Cheong å—æ˜Œ", line: "tw" },
          { from: "Nam Cheong å—æ˜Œ", to: "Austin æŸ¯å£«ç”¸", line: "tw" },
          { from: "Austin æŸ¯å£«ç”¸", to: "East Tsim Sha Tsui å°–æ±", line: "tw" },
          { from: "East Tsim Sha Tsui å°–æ±", to: "Hung Hom ç´…ç£¡", line: "tw" },
          { from: "Hung Hom ç´…ç£¡", to: "Ho Man Tin ä½•æ–‡ç”°", line: "tw" },
          { from: "Ho Man Tin ä½•æ–‡ç”°", to: "Sung Wong Toi å®‹çš‡è‡º", line: "tw" },
          { from: "Sung Wong Toi å®‹çš‡è‡º", to: "To Kwa Wan åœŸç“œç£", line: "tw" },
          { from: "To Kwa Wan åœŸç“œç£", to: "Kai Tak å•Ÿå¾·", line: "tw" },
          { from: "Kai Tak å•Ÿå¾·", to: "Diamond Hill é‘½çŸ³å±±", line: "tw" },
          { from: "Diamond Hill é‘½çŸ³å±±", to: "Hin Keng é¡¯å¾‘", line: "tw" },
          { from: "Hin Keng é¡¯å¾‘", to: "Tai Wai å¤§åœ", line: "tw" },
          { from: "Tai Wai å¤§åœ", to: "Che Kung Temple è»Šå…¬å»Ÿ", line: "tw" },
          {
            from: "Che Kung Temple è»Šå…¬å»Ÿ",
            to: "Sha Tin Wai æ²™ç”°åœ",
            line: "tw",
          },
          { from: "Sha Tin Wai æ²™ç”°åœ", to: "City One ç¬¬ä¸€åŸ", line: "tw" },
          { from: "City One ç¬¬ä¸€åŸ", to: "Shek Mun çŸ³é–€", line: "tw" },
          { from: "Shek Mun çŸ³é–€", to: "Tai Shui Hang å¤§æ°´å‘", line: "tw" },
          { from: "Tai Shui Hang å¤§æ°´å‘", to: "Heng On æ’å®‰", line: "tw" },
          { from: "Heng On æ’å®‰", to: "Ma On Shan é¦¬éå±±", line: "tw" },
          { from: "Ma On Shan é¦¬éå±±", to: "Wu Kai Sha çƒæºªæ²™", line: "tw" },

          // æ±æ¶Œç·š
          { from: "Tung Chung æ±æ¶Œ", to: "Sunny Bay æ¬£æ¾³", line: "tcl" },
          { from: "Sunny Bay æ¬£æ¾³", to: "Tsing Yi é’è¡£", line: "tcl" },
          { from: "Tsing Yi é’è¡£", to: "Lai King è”æ™¯", line: "tcl" },
          { from: "Lai King è”æ™¯", to: "Nam Cheong å—æ˜Œ", line: "tcl" },
          { from: "Nam Cheong å—æ˜Œ", to: "Olympic å¥§é‹", line: "tcl" },
          { from: "Olympic å¥§é‹", to: "Kowloon ä¹é¾", line: "tcl" },
          { from: "Kowloon ä¹é¾", to: "Hong Kong é¦™æ¸¯", line: "tcl" },

          // èƒç£ç·š
          { from: "Tsuen Wan èƒç£", to: "Tai Wo Hau å¤§çª©å£", line: "twl" },
          { from: "Tai Wo Hau å¤§çª©å£", to: "Kwai Hing è‘µèˆˆ", line: "twl" },
          { from: "Kwai Hing è‘µèˆˆ", to: "Kwai Fong è‘µèŠ³", line: "twl" },
          { from: "Kwai Fong è‘µèŠ³", to: "Lai King è”æ™¯", line: "twl" },
          { from: "Lai King è”æ™¯", to: "Mei Foo ç¾å­š", line: "twl" },
          { from: "Mei Foo ç¾å­š", to: "Lai Chi Kok è”æè§’", line: "twl" },
          {
            from: "Lai Chi Kok è”æè§’",
            to: "Cheung Sha Wan é•·æ²™ç£",
            line: "twl",
          },
          {
            from: "Cheung Sha Wan é•·æ²™ç£",
            to: "Sham Shui Po æ·±æ°´åŸ—",
            line: "twl",
          },
          {
            from: "Sham Shui Po æ·±æ°´åŸ—",
            to: "Prince Edward å¤ªå­",
            line: "twl",
          },
          { from: "Prince Edward å¤ªå­", to: "Mong Kok æ—ºè§’", line: "twl" },
          { from: "Mong Kok æ—ºè§’", to: "Yau Ma Tei æ²¹éº»åœ°", line: "twl" },
          { from: "Yau Ma Tei æ²¹éº»åœ°", to: "Jordan ä½æ•¦", line: "twl" },
          { from: "Jordan ä½æ•¦", to: "Tsim Sha Tsui å°–æ²™å’€", line: "twl" },
          { from: "Tsim Sha Tsui å°–æ²™å’€", to: "Admiralty é‡‘é˜", line: "twl" },
          { from: "Admiralty é‡‘é˜", to: "Central ä¸­ç’°", line: "twl" },

          // æ¸¯å³¶ç·š
          { from: "Kennedy Town å …å°¼åœ°åŸ", to: "HKU é¦™æ¸¯å¤§å­¸", line: "il" },
          { from: "HKU é¦™æ¸¯å¤§å­¸", to: "Sai Ying Pun è¥¿ç‡Ÿç›¤", line: "il" },
          { from: "Sai Ying Pun è¥¿ç‡Ÿç›¤", to: "Sheung Wan ä¸Šç’°", line: "il" },
          { from: "Sheung Wan ä¸Šç’°", to: "Central ä¸­ç’°", line: "il" },
          { from: "Central ä¸­ç’°", to: "Admiralty é‡‘é˜", line: "il" },
          { from: "Admiralty é‡‘é˜", to: "Wan Chai ç£ä»”", line: "il" },
          { from: "Wan Chai ç£ä»”", to: "Causeway Bay éŠ…é‘¼ç£", line: "il" },
          { from: "Causeway Bay éŠ…é‘¼ç£", to: "Tin Hau å¤©å", line: "il" },
          { from: "Tin Hau å¤©å", to: "Fortress Hill ç‚®å°å±±", line: "il" },
          { from: "Fortress Hill ç‚®å°å±±", to: "North Point åŒ—è§’", line: "il" },
          { from: "North Point åŒ—è§’", to: "Quarry Bay é°‚é­šæ¶Œ", line: "il" },
          { from: "Quarry Bay é°‚é­šæ¶Œ", to: "Tai Koo å¤ªå¤", line: "il" },
          { from: "Tai Koo å¤ªå¤", to: "Sai Wan Ho è¥¿ç£æ²³", line: "il" },
          { from: "Sai Wan Ho è¥¿ç£æ²³", to: "Shau Kei Wan ç­²ç®•ç£", line: "il" },
          {
            from: "Shau Kei Wan ç­²ç®•ç£",
            to: "Heng Fa Chuen æèŠ±é‚¨",
            line: "il",
          },
          { from: "Heng Fa Chuen æèŠ±é‚¨", to: "Chai Wan æŸ´ç£", line: "il" },

          // æ±éµç·š
          { from: "Lok Ma Chau è½é¦¬æ´²", to: "Sheung Shui ä¸Šæ°´", line: "erl" },
          { from: "Sheung Shui ä¸Šæ°´", to: "Fanling ç²‰å¶º", line: "erl" },
          { from: "Fanling ç²‰å¶º", to: "Tai Wo å¤ªå’Œ", line: "erl" },
          { from: "Tai Wo å¤ªå’Œ", to: "Tai Po Market å¤§åŸ”å¢Ÿ", line: "erl" },
          { from: "Tai Po Market å¤§åŸ”å¢Ÿ", to: "University å¤§å­¸", line: "erl" },
          { from: "University å¤§å­¸", to: "Fo Tan ç«ç‚­", line: "erl" },
          { from: "Fo Tan ç«ç‚­", to: "Sha Tin æ²™ç”°", line: "erl" },
          { from: "Sha Tin æ²™ç”°", to: "Tai Wai å¤§åœ", line: "erl" },
          { from: "Tai Wai å¤§åœ", to: "Kowloon Tong ä¹é¾å¡˜", line: "erl" },
          {
            from: "Kowloon Tong ä¹é¾å¡˜",
            to: "Mong Kok East æ—ºè§’æ±",
            line: "erl",
          },
          { from: "Mong Kok East æ—ºè§’æ±", to: "Hung Hom ç´…ç£¡", line: "erl" },
          { from: "Hung Hom ç´…ç£¡", to: "Exhibition Centre æœƒå±•", line: "erl" },
          { from: "Exhibition Centre æœƒå±•", to: "Admiralty é‡‘é˜", line: "erl" },

          // å°‡è»æ¾³ç·š
          { from: "LOHAS Park åº·åŸ", to: "Po Lam å¯¶ç³", line: "tkl" },
          { from: "Po Lam å¯¶ç³", to: "Hang Hau å‘å£", line: "tkl" },
          { from: "Hang Hau å‘å£", to: "Tseung Kwan O å°‡è»æ¾³", line: "tkl" },
          {
            from: "Tseung Kwan O å°‡è»æ¾³",
            to: "Tiu Keng Leng èª¿æ™¯å¶º",
            line: "tkl",
          },
          { from: "Tiu Keng Leng èª¿æ™¯å¶º", to: "Yau Tong æ²¹å¡˜", line: "tkl" },
          { from: "Yau Tong æ²¹å¡˜", to: "Quarry Bay é°‚é­šæ¶Œ", line: "tkl" },
          { from: "Quarry Bay é°‚é­šæ¶Œ", to: "North Point åŒ—è§’", line: "tkl" },

          // è§€å¡˜ç·š
          { from: "Whampoa é»ƒåŸ”", to: "Ho Man Tin ä½•æ–‡ç”°", line: "ktl" },
          { from: "Ho Man Tin ä½•æ–‡ç”°", to: "Yau Ma Tei æ²¹éº»åœ°", line: "ktl" },
          { from: "Yau Ma Tei æ²¹éº»åœ°", to: "Mong Kok æ—ºè§’", line: "ktl" },
          { from: "Mong Kok æ—ºè§’", to: "Prince Edward å¤ªå­", line: "ktl" },
          {
            from: "Prince Edward å¤ªå­",
            to: "Shek Kip Mei çŸ³ç¡¤å°¾",
            line: "ktl",
          },
          {
            from: "Shek Kip Mei çŸ³ç¡¤å°¾",
            to: "Kowloon Tong ä¹é¾å¡˜",
            line: "ktl",
          },
          { from: "Kowloon Tong ä¹é¾å¡˜", to: "Lok Fu æ¨‚å¯Œ", line: "ktl" },
          { from: "Lok Fu æ¨‚å¯Œ", to: "Wong Tai Sin é»ƒå¤§ä»™", line: "ktl" },
          {
            from: "Wong Tai Sin é»ƒå¤§ä»™",
            to: "Diamond Hill é‘½çŸ³å±±",
            line: "ktl",
          },
          { from: "Diamond Hill é‘½çŸ³å±±", to: "Choi Hung å½©è™¹", line: "ktl" },
          { from: "Choi Hung å½©è™¹", to: "Kowloon Bay ä¹é¾ç£", line: "ktl" },
          {
            from: "Kowloon Bay ä¹é¾ç£",
            to: "Ngau Tau Kok ç‰›é ­è§’",
            line: "ktl",
          },
          { from: "Ngau Tau Kok ç‰›é ­è§’", to: "Kwun Tong è§€å¡˜", line: "ktl" },
          { from: "Kwun Tong è§€å¡˜", to: "Lam Tin è—ç”°", line: "ktl" },
          { from: "Lam Tin è—ç”°", to: "Yau Tong æ²¹å¡˜", line: "ktl" },
          { from: "Yau Tong æ²¹å¡˜", to: "Tiu Keng Leng èª¿æ™¯å¶º", line: "ktl" },
        ],

        // ç²å–ç›¸é„°è»Šç«™
        getConnectedStations(stationName) {
          const connected = [];
          this.connections.forEach((conn) => {
            if (conn.from === stationName) {
              connected.push(conn.to);
            } else if (conn.to === stationName) {
              connected.push(conn.from);
            }
          });
          return connected;
        },

        // ç²å–æ­¤è»Šç«™å¯ä½¿ç”¨çš„è·¯ç·š (å¾ connections æ¨å°)
        getLinesAtStation(stationName) {
          const lines = new Set();
          this.connections.forEach((conn) => {
            if (conn.from === stationName || conn.to === stationName) {
              if (conn.line) lines.add(conn.line);
            }
          });
          return Array.from(lines);
        },

        // åˆ¤æ–·ä¸€å€‹ç«™æ˜¯å¦ç‚ºæ›ä¹˜ç«™ï¼ˆæœ‰å¤šæ–¼ä¸€æ¢è·¯ç·šç¶“éï¼‰
        isInterchange(stationName) {
          return this.getLinesAtStation(stationName).length > 1;
        },

        // åœ¨æŒ‡å®šè·¯ç·šä¸Šï¼Œç²å–èˆ‡ station ç›¸é€£çš„ç›¸é„°è»Šç«™ï¼ˆé›™å‘ï¼‰
        getAdjacentStationsOnLine(stationName, lineCode) {
          const neighbors = [];
          this.connections.forEach((conn) => {
            if (conn.line !== lineCode) return;
            if (conn.from === stationName) neighbors.push(conn.to);
            else if (conn.to === stationName) neighbors.push(conn.from);
          });
          return neighbors;
        },

        // å–å¾—æŒ‡å®šè·¯ç·šçš„æœ‰åºç«™é»åºåˆ—ï¼ˆå˜—è©¦æ ¹æ“š connections é‚è¼¯é‚„åŸé †åºï¼‰
        getLineSequence(lineCode) {
          // å»ºç«‹è©²è·¯ç·šä¸Šçš„é„°æ¥è¡¨
          const adj = {};
          this.connections.forEach((conn) => {
            if (conn.line !== lineCode) return;
            adj[conn.from] = adj[conn.from] || new Set();
            adj[conn.to] = adj[conn.to] || new Set();
            adj[conn.from].add(conn.to);
            adj[conn.to].add(conn.from);
          });

          const nodes = Object.keys(adj);
          if (nodes.length === 0) return [];

          // æ‰¾åˆ°ä¸€å€‹ç«¯é»ï¼ˆdegree 1ï¼‰ä½œç‚ºèµ·é»ï¼Œè‹¥æ‰¾ä¸åˆ°å°±ä»»å–ä¸€å€‹
          let start = nodes.find((n) => adj[n].size === 1) || nodes[0];

          const seq = [];
          const visited = new Set();
          let current = start;
          let prev = null;
          while (current && !visited.has(current)) {
            seq.push(current);
            visited.add(current);
            const neighbors = Array.from(adj[current]).filter(
              (x) => x !== prev
            );
            if (neighbors.length > 0) {
              prev = current;
              current = neighbors[0];
            } else {
              break;
            }
          }
          return seq;
        },

        // ç²å–è»Šç«™ä¿¡æ¯
        getStation(stationName) {
          return this.stations[stationName];
        },

        // ç²å–éš¨æ©Ÿèµ·å§‹ç«™
        getRandomStart() {
          const startingStations = [
            "Tsuen Wan èƒç£",
            "Tuen Mun å±¯é–€",
            "Tung Chung æ±æ¶Œ",
            "Lok Ma Chau è½é¦¬æ´²",
            "Kennedy Town å …å°¼åœ°åŸ",
          ];
          const randomIndex = Math.floor(
            Math.random() * startingStations.length
          );
          return startingStations[randomIndex];
        },
      };

      // éŠæˆ²ä¸»é¡
      class FinanceGame {
        constructor(studentId, nickname) {
          this.studentId = studentId;
          this.nickname = nickname;

          // éŠæˆ²æ™‚é–“è¨­ç½®
          this.startDate = new Date(2025, 9, 12); // 2025å¹´10æœˆ12æ—¥
          this.currentDate = new Date(2025, 9, 12);
          this.currentDay = 1;
          this.totalDays = 365;

          this.previousStation = null;
          this.visitedStations = new Set();
          this.stationHistory = []; // è¨˜éŒ„ç§»å‹•æ­·å²

          // ç©å®¶ç‹€æ…‹
          this.player = {
            name: nickname,
            assets: 500,
            currentStation: gameBoard.getRandomStart(),
            // åˆå§‹åŒ–æ™‚ï¼Œå¦‚æœè©²ç«™æœ‰å¤šæ¢ç·šï¼Œé è¨­å–ç¬¬ä¸€æ¢
            line: null,
            // direction: 1 = forward, -1 = backward
            direction: 1,
            dailySavings: 1,
            weeklyAllowance: 300,
            totalSavings: 0,
            // ç´¯ç©ç²å¾—é‡‘é¡ï¼ˆåŒ…å«å„²è“„ã€é›¶ç”¨éŒ¢ã€æŠ•è³‡æ”¶ç›Šèˆ‡å…¶ä»–æ­£å‘ effectï¼‰
            cumulativeGains: 0,
            weeklyAllowanceReceived: false,
            // æŠ•è³‡ç›¸é—œ
            investment: 0, // ç›®å‰æŠ•è³‡çš„ç¸½é‡‘é¡
            lastInvestmentDay: 0, // ä¸Šæ¬¡æŠ•è³‡çš„éŠæˆ²å¤©æ•¸
          };

          // åˆå§‹åŒ–ç©å®¶ç·šè·¯ï¼ˆå–è©²ç«™å¯ç”¨çš„ç¬¬ä¸€æ¢ç·šï¼‰
          const startLines = gameBoard.getLinesAtStation(
            this.player.currentStation
          );
          this.player.line =
            startLines.length > 0
              ? startLines[0]
              : this.getLineFromStation(this.player.currentStation);

          // è¨˜éŒ„èµ·å§‹ç«™
          this.visitedStations.add(this.player.currentStation);
          this.stationHistory.push(this.player.currentStation);

          // ç‰©åƒ¹æŒ‡æ•¸
          this.priceIndex = {
            tw: 1.015, // å±¯é¦¬ç·š 1.5%
            twl: 1.03, // èƒç£ç·š 3%
            tcl: 1.05, // æ±æ¶Œç·š 5%
            erl: 1.07, // æ±éµç·š 7%
            ktl: 1.09, // è§€å¡˜ç·š 9%
            tkl: 1.09, // å°‡è»æ¾³ç·š 9%
            il: 1.1, // æ¸¯å³¶ç·š 10%
          };

          // å¥½äº‹ä»¶åº«
          this.goodEvents = [
            {
              title: "ï¿½ Tutoring è£œç¿’æ”¶å…¥",
              message:
                "You earned money from tutoring!\nä½ å¾è£œç¿’è³ºåˆ°äº†é¡å¤–æ”¶å…¥ï¼",
              effect: { cash: 200 },
            },
            {
              title: "ğŸ¯ Part-time Job å…¼è·æ”¶å…¥",
              message:
                "You got paid from your part-time job!\nä½ æ”¶åˆ°å…¼è·è–ªæ°´ï¼",
              effect: { cash: 250 },
            },
            {
              title: "ğŸ Red Packet æ”¶åˆ°ç´…åŒ…",
              message: "You received a red packet!\nä½ æ”¶åˆ°äº†ç´…åŒ…ï¼",
              effect: { cash: 100 },
            },
            {
              title: "ğŸ’¼ Freelance Work è‡ªç”±æ¥æ¡ˆ",
              message:
                "You completed a freelance project!\nä½ å®Œæˆäº†ä¸€å€‹è‡ªç”±æ¥æ¡ˆï¼",
              effect: { cash: 180 },
            },
            {
              title: "ğŸ“ˆ Market Up è‚¡å¸‚ä¸Šæ¼²",
              message: "Your investments gained value!\nä½ çš„æŠ•è³‡å¢å€¼äº†ï¼",
              effect: { investmentReturn: 1.2 }, // æŠ•è³‡é‡‘é¡å¢åŠ  20%
            },
          ];

          // å£äº‹ä»¶åº«
          this.badEvents = [
            {
              title: "ğŸš¨ Phone Scam é›»è©±è©é¨™",
              message: "You received a scam call!\nä½ æ¥åˆ°è©é¨™é›»è©±ï¼",
              effect: { cash: -200 },
            },
            {
              title: "ğŸŒ€ Typhoon Delay å…«è™Ÿé¢¨çƒ",
              message:
                "Typhoon signal No.8! Train delayed.\nå…«è™Ÿé¢¨çƒï¼åˆ—è»Šå»¶èª¤ã€‚",
              effect: { moveBack: true },
            },
            {
              title: "ğŸš· Traffic Fine äº¤é€šç½°å–®",
              message:
                "You got a traffic violation ticket!\nä½ æ”¶åˆ°ä¸€å¼µäº¤é€šç½°å–®ï¼",
              effect: { cash: -150 },
            },
            {
              title: "ğŸ“‰ Market Down è‚¡å¸‚ä¸‹è·Œ",
              message: "Stock market crashed!\nè‚¡å¸‚æš´è·Œï¼",
              effect: { investmentReturn: 0.8 }, // æŠ•è³‡é‡‘é¡æ¸›å°‘ 20%
            },
            {
              title: "ğŸ›ï¸ Impulse Shopping è¡å‹•æ¶ˆè²»",
              message:
                "You spent money on unnecessary items!\nä½ åšäº†è¡å‹•æ¶ˆè²»ï¼",
              effect: { cash: -180 },
            },
            {
              title: "ğŸ¥ Medical Expense é†«ç™‚æ”¯å‡º",
              message: "You had to visit the doctor!\nä½ éœ€è¦çœ‹é†«ç”Ÿï¼",
              effect: { cash: -250 },
            },
            {
              title: "ğŸ“± Phone Repair æ‰‹æ©Ÿç¶­ä¿®",
              message: "Your phone needs repair!\nä½ çš„æ‰‹æ©Ÿéœ€è¦ç¶­ä¿®ï¼",
              effect: { cash: -220 },
            },
            {
              title: "ğŸ® Gaming Loss éŠæˆ²æ¶ˆè²»",
              message: "You spent too much on games!\nä½ åœ¨éŠæˆ²ä¸ŠèŠ±å¤ªå¤šéŒ¢ï¼",
              effect: { cash: -160 },
            },
          ];

          // ç†è²¡å•ç­”é¡Œåº«
          this.financeQuestions = [
            {
              question: "æ‡‰è©²å„²è“„è‡³å°‘20%çš„æ”¶å…¥å—ï¼Ÿ",
              correct: true,
              explanation: "æ˜¯çš„ï¼é¤Šæˆå„²è“„ç¿’æ…£å¯ä»¥å»ºç«‹ç©©å›ºçš„è²¡å‹™åŸºç¤ã€‚",
            },
            {
              question: "æŠŠæ‰€æœ‰éŒ¢æŠ•è³‡åœ¨ä¸€éš»è‚¡ç¥¨æ˜¯æ˜æ™ºçš„å—ï¼Ÿ",
              correct: false,
              explanation: "ä¸å°ï¼æ‡‰è©²åˆ†æ•£æŠ•è³‡ä»¥é™ä½é¢¨éšªã€‚",
            },
            {
              question: "æ‡‰è©²åœ¨å¤§å­¸å°±é–‹å§‹è·æ¶¯è¦åŠƒå—ï¼Ÿ",
              correct: true,
              explanation: "æ˜¯çš„ï¼åŠæ—©è¦åŠƒæœ‰åŠ©æ–¼æœªä¾†ç™¼å±•ã€‚",
            },
            {
              question: "å€ŸéŒ¢è²·å¥¢ä¾ˆå“æ˜¯å¥½çš„è²¡å‹™æ±ºå®šå—ï¼Ÿ",
              correct: false,
              explanation: "ä¸å°ï¼æ‡‰é¿å…ç‚ºéå¿…éœ€å“è² å‚µã€‚",
            },
            {
              question: "æ‡‰è©²æœ‰3-6å€‹æœˆé–‹æ”¯çš„æ‡‰æ€¥åŸºé‡‘å—ï¼Ÿ",
              correct: true,
              explanation: "æ˜¯çš„ï¼æ‡‰æ€¥åŸºé‡‘å¯ä»¥æ‡‰ä»˜çªç™¼æƒ…æ³ã€‚",
            },
            {
              question: "æŠ•è³‡æ™‚æ‡‰è©²è¿½é«˜æ®ºä½å—ï¼Ÿ",
              correct: false,
              explanation: "ä¸å°ï¼æ‡‰è©²éµå¾ªåƒ¹å€¼æŠ•è³‡åŸå‰‡ã€‚",
            },
            {
              question: "å®šæœŸå®šé¡æŠ•è³‡æ˜¯å¥½çš„ç†è²¡æ–¹å¼å—ï¼Ÿ",
              correct: true,
              explanation: "æ˜¯çš„ï¼å¯ä»¥å¹³å‡æˆæœ¬ï¼Œé™ä½å¸‚å ´æ³¢å‹•é¢¨éšªã€‚",
            },
            {
              question: "ä¿¡ç”¨å¡åˆ·çˆ†æ›ç¾é‡‘æ˜¯å¥½ä¸»æ„å—ï¼Ÿ",
              correct: false,
              explanation: "ä¸å°ï¼é€™æœƒå°è‡´é«˜é¡åˆ©æ¯æ”¯å‡ºã€‚",
            },
            {
              question: "æŠ•è³‡çµ„åˆæ‡‰è©²å®šæœŸæª¢è¦–ä¸¦èª¿æ•´å—ï¼Ÿ",
              correct: true,
              explanation: "æ˜¯çš„ï¼å®šæœŸæª¢è¦–å¯ä»¥ç¢ºä¿æŠ•è³‡ç­–ç•¥ç¬¦åˆç›®æ¨™ã€‚",
            },
            {
              question: "æ”¶å…¥å¢åŠ æ™‚ï¼Œæ‡‰è©²ç›¸æ‡‰æé«˜å„²è“„æ¯”ä¾‹å—ï¼Ÿ",
              correct: true,
              explanation: "æ˜¯çš„ï¼é¿å…ç”Ÿæ´»è†¨è„¹ï¼Œå„ªå…ˆæé«˜å„²è“„ã€‚",
            },
          ];

          this.initializeGame();
        }

        getLineFromStation(stationName) {
          // å„ªå…ˆä½¿ç”¨ç”± connections æ¨å°å‡ºçš„å¯ç”¨è·¯ç·š
          const lines = gameBoard.getLinesAtStation(stationName);
          if (lines && lines.length > 0) return lines[0];
          const station = gameBoard.stations[stationName];
          return station && station.line ? station.line.split(",")[0] : "twl";
        }

        initializeGame() {
          this.updateDisplay();
          this.drawGameBoard();
          this.showPlayerAtStation(this.player.currentStation);

          // åœ¨è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡ç¹ªåœ°åœ–ç·šæ®µï¼Œç¢ºä¿ç·šæ®µåƒç´ é•·åº¦æ­£ç¢º
          this._resizeHandler = () => this.drawGameBoard();
          window.addEventListener("resize", this._resizeHandler);
        }

        nextDay() {
          if (this.currentDay > this.totalDays) {
            this.showGameOver();
            return;
          }

          // æ›´æ–°æ—¥æœŸå’Œå¤©æ•¸
          this.currentDate.setDate(this.currentDate.getDate() + 1);
          this.currentDay++;

          // è¨˜éŒ„ä¸Šä¸€å€‹è»Šç«™
          this.previousStation = this.player.currentStation;

          // === è²¡å‹™è¨ˆç®— ===
          let dailyReport = [];

          // 1. å¼·åˆ¶å„²è“„ (ç¬¬1å¤©$1, ç¬¬2å¤©$2, ç¬¬3å¤©$3...)
          const todaySavings = this.currentDay;
          this.player.assets += todaySavings;
          this.player.totalSavings += todaySavings;
          // ç´¯åŠ åˆ°ç´¯ç©ç²å¾—
          this.player.cumulativeGains += todaySavings;
          dailyReport.push(`ğŸ’° å¼·åˆ¶å„²è“„: +$${todaySavings}`);

          // 2. æ¯é€±é›¶ç”¨éŒ¢ (æ¯é€±æ—¥ç™¼æ”¾$300)
          const isSunday = this.currentDate.getDay() === 0;
          if (isSunday) {
            this.player.assets += this.player.weeklyAllowance;
            // ç´¯ç©ç²å¾—ä¹Ÿè¦è¨ˆå…¥é€±è–ª
            this.player.cumulativeGains += this.player.weeklyAllowance;
            dailyReport.push(`ğŸ‰ é€±æœ«é›¶ç”¨éŒ¢: +$${this.player.weeklyAllowance}`);
          }

          // é‡ç½®æ¯é€±é›¶ç”¨éŒ¢æ¨™è¨˜ (æ¯é€±ä¸€é‡ç½®)
          if (this.currentDate.getDay() === 1) {
            this.player.weeklyAllowanceReceived = false;
          }

          // 3. æ—¥å¸¸é–‹æ”¯
          const isWeekend =
            this.currentDate.getDay() === 0 || this.currentDate.getDay() === 6;
          const transportCost = isWeekend ? 10 : 20; // é€±æœ«$10, å¹³æ—¥$20
          const mealCost = 30; // è†³é£Ÿè²»$30
          const dailyExpense = transportCost + mealCost;
          this.player.assets -= dailyExpense;
          dailyReport.push(`ğŸš‡ äº¤é€šè²»: -$${transportCost}`);
          dailyReport.push(`ğŸœ è†³é£Ÿè²»: -$${mealCost}`);

          // 4. æ‡‰ç”¨ç‰©åƒ¹æŒ‡æ•¸
          const currentPriceIndex = this.priceIndex[this.player.line] || 1;
          const inflationEffect = Math.floor(
            this.player.assets * (currentPriceIndex - 1)
          );
          if (inflationEffect !== 0) {
            this.player.assets = Math.floor(
              this.player.assets * currentPriceIndex
            );
            dailyReport.push(`ğŸ“ˆ ç‰©åƒ¹å½±éŸ¿: -$${inflationEffect}`);
          }

          // é¡¯ç¤ºæ—¥å ±
          this.showMessage(
            `==== ç¬¬ ${this.currentDay} å¤©è²¡å‹™å ±å‘Š ====\n${dailyReport.join(
              "\n"
            )}\n==================\nç•¶å‰ç¸½è³‡ç”¢: $${this.player.assets}`
          );

          // ç§»å‹•åˆ°ä¸‹ä¸€ç«™
          this.moveToNextStation();

          // æ›´æ–°é¡¯ç¤º
          this.updateDisplay();

          // è§¸ç™¼äº‹ä»¶
          this.triggerStationEvent();

          // æª¢æŸ¥é€šé—œæ¢ä»¶
          if (this.player.assets >= 10000) {
            this.showVictory();
          }

          console.log(
            `Day ${this.currentDay}: ${this.formatDate(
              this.currentDate
            )} | Station: ${this.player.currentStation} | Assets: $${
              this.player.assets
            } | Savings: $${todaySavings} | Expense: $${dailyExpense}`
          );
        }

        formatDate(date) {
          const year = date.getFullYear();
          const month = (date.getMonth() + 1).toString().padStart(2, "0");
          const day = date.getDate().toString().padStart(2, "0");
          const weekdays = [
            "æ˜ŸæœŸæ—¥",
            "æ˜ŸæœŸä¸€",
            "æ˜ŸæœŸäºŒ",
            "æ˜ŸæœŸä¸‰",
            "æ˜ŸæœŸå››",
            "æ˜ŸæœŸäº”",
            "æ˜ŸæœŸå…­",
          ];
          const weekday = weekdays[date.getDay()];
          return `${year}-${month}-${day} ${weekday}`;
        }

        moveToNextStation() {
          const currentLine = this.player.line;
          // å„ªå…ˆä½¿ç”¨è©²è·¯ç·šçš„ç«™é»åºåˆ—ä¾†æ±ºå®šä¸‹ä¸€ç«™
          if (currentLine) {
            const seq = gameBoard.getLineSequence(currentLine);
            if (seq && seq.length > 0) {
              const idx = seq.indexOf(this.player.currentStation);
              if (idx === -1) {
                // å¦‚æœç›®å‰ç«™ä¸åœ¨åºåˆ—ä¸­ï¼Œé€€å›åˆ°ç›¸é„°ç«™é‚è¼¯
              } else {
                let nextIdx = idx + (this.player.direction || 1);
                // åˆ°é”çµ‚é»ï¼šåæ–¹å‘
                if (nextIdx < 0 || nextIdx >= seq.length) {
                  this.player.direction = -(this.player.direction || 1);
                  nextIdx = idx + (this.player.direction || 1);
                }

                const nextStation = seq[nextIdx];
                if (nextStation) {
                  this.visitedStations.add(nextStation);
                  this.stationHistory.push(nextStation);
                  this.player.currentStation = nextStation;
                  this.showPlayerAtStation(nextStation);
                  // åˆ°é”æ›ä¹˜ç«™æ™‚è®“ç©å®¶é¸æ“‡è·¯ç·š
                  if (gameBoard.isInterchange(nextStation)) {
                    this.showLineSelection(nextStation);
                  }
                  return;
                }
              }
            }
          }

          // fallback: ä½¿ç”¨åŸæœ¬ç›¸é„°ç«™é¸æ“‡é‚è¼¯ï¼ˆä¸ä¾åºåˆ—ï¼‰
          let adjacent = [];
          if (currentLine) {
            adjacent = gameBoard.getAdjacentStationsOnLine(
              this.player.currentStation,
              currentLine
            );
          } else {
            adjacent = gameBoard.getConnectedStations(
              this.player.currentStation
            );
          }

          if (adjacent.length > 0) {
            const unvisited = adjacent.filter(
              (s) => !this.visitedStations.has(s)
            );
            let nextStation = null;
            if (unvisited.length > 0)
              nextStation =
                unvisited[Math.floor(Math.random() * unvisited.length)];
            else
              nextStation =
                adjacent[Math.floor(Math.random() * adjacent.length)];

            this.visitedStations.add(nextStation);
            this.stationHistory.push(nextStation);
            this.player.currentStation = nextStation;
            this.showPlayerAtStation(nextStation);
            if (gameBoard.interchangeStations.includes(nextStation))
              this.showLineSelection(nextStation);
          }
        }

        moveBackStation() {
          if (this.stationHistory.length > 1) {
            // ç§»é™¤ç•¶å‰è»Šç«™
            this.stationHistory.pop();
            // å›åˆ°ä¸Šä¸€å€‹è»Šç«™
            const previousStation =
              this.stationHistory[this.stationHistory.length - 1];
            this.player.currentStation = previousStation;
            this.player.line = this.getLineFromStation(previousStation);
            this.showPlayerAtStation(previousStation);
            this.updateDisplay();
          }
        }

        showLineSelection(station) {
          // ä½¿ç”¨ gameBoard æ¨å°è©²ç«™å¯ç”¨çš„è·¯ç·š
          const availableLines = gameBoard.getLinesAtStation(station);

          const modal = document.getElementById("eventModal");
          const eventTitle = document.getElementById("eventTitle");
          const eventMessage = document.getElementById("eventMessage");
          const eventChoices = document.getElementById("eventChoices");

          eventTitle.textContent = "ğŸ”„ è½‰è»Šç«™é¸æ“‡";
          eventMessage.textContent = `ä½ å·²åˆ°é” ${station}ï¼Œè«‹é¸æ“‡è¦ç¹¼çºŒçš„è·¯ç·šï¼š`;
          eventChoices.innerHTML = "";

          // å¦‚æœåªæœ‰ä¸€æ¢è·¯ç·šï¼Œç›´æ¥è¨­ç‚ºè©²ç·š
          if (!availableLines || availableLines.length === 0) {
            this.player.currentStation = station;
            this.player.line = this.getLineFromStation(station);
            this.showPlayerAtStation(station);
            return;
          }

          // å»ºç«‹æ¯æ¢å¯é¸è·¯ç·šæŒ‰éˆ•ï¼Œç©å®¶é¸æ“‡å¾Œå°‡ä¾è©²ç·šè·¯å‰é€²ï¼ˆé›™å‘ï¼‰
          availableLines.forEach((line) => {
            // å»ºç«‹å‘å‰å’Œå‘å¾Œå…©å€‹æŒ‰éˆ•
            [-1, 1].forEach((direction) => {
              const seq = gameBoard.getLineSequence(line);
              const idx = seq.indexOf(station);
              // æª¢æŸ¥è©²æ–¹å‘æ˜¯å¦æœ‰ä¸‹ä¸€ç«™
              const nextIdx = idx + direction;
              if (nextIdx >= 0 && nextIdx < seq.length) {
                const button = document.createElement("button");
                button.className = "choice-btn primary";
                const nextStation = seq[nextIdx];
                button.textContent = `${this.getLineName(line)} ${
                  direction > 0 ? "â¡ï¸" : "â¬…ï¸"
                } ${nextStation}`;
                button.onclick = () => {
                  this.player.currentStation = station;
                  this.player.line = line;
                  this.player.direction = direction;
                  this.showPlayerAtStation(station);
                  this.updateDisplay();
                  modal.classList.remove("active");
                };
                eventChoices.appendChild(button);
              }
            });
          });

          modal.classList.add("active");
        }

        getLineName(lineCode) {
          const lineNames = {
            twl: "Tsuen Wan Line èƒç£ç·š",
            tw: "Tuen Ma Line å±¯é¦¬ç·š",
            tcl: "Tung Chung Line æ±æ¶Œç·š",
            erl: "East Rail Line æ±éµç·š",
            ktl: "Kwun Tong Line è§€å¡˜ç·š",
            tkl: "Tseung Kwan O Line å°‡è»æ¾³ç·š",
            il: "Island Line æ¸¯å³¶ç·š",
          };
          return lineNames[lineCode] || lineCode;
        }

        triggerStationEvent() {
          const station = this.player.currentStation;

          // ç‰¹æ®Šç«™é»ï¼ˆéœ€é¡å¤–èŠ±è²»çš„é»ï¼‰
          // å·²åˆªé™¤èˆ‡æŠ•è³‡ç«™é»é‡è¤‡çš„æ¢ç›®ï¼ˆæŠ•è³‡ç«™é»æœƒç”±æŠ•è³‡é¸é …æ§åˆ¶ï¼Œä¸å†é‡è¤‡é¡¯ç¤ºèŠ±è²»é¸é …ï¼‰
          const specialEvents = {
            "Kwai Fong è‘µèŠ³": [
              { text: "é€›å•†å ´ Mall Shopping", cost: 80 },
              { text: "åœ¨å®¶ä¼‘æ¯ Stay Home", cost: 40 },
            ],
            "Tsim Sha Tsui å°–æ²™å’€": [
              { text: "é«˜ç´šæ™šé¤ Fine Dining", cost: 80 },
              { text: "è¡—é ­å°åƒ Street Food", cost: 60 },
            ],
            "Yuen Long å…ƒæœ—": [
              { text: "å¸‚é›†è³¼ç‰© Market Shopping", cost: 80 },
              { text: "çœéŒ¢æ•£æ­¥ Cheap Walk", cost: 20 },
            ],
            "Sung Wong Toi å®‹çš‡è‡º": [
              { text: "æ‹ç…§ç•™å¿µ Photo", cost: 30 },
              { text: "å¿«é€Ÿé€šé Skip", cost: 10 },
            ],
            "City One ç¬¬ä¸€åŸ": [
              { text: "å•†å ´è³¼ç‰© Mall", cost: 90 },
              { text: "å’–å•¡ä¼‘æ¯ Coffee", cost: 40 },
            ],
            "University å¤§å­¸": [
              { text: "åœ–æ›¸é¤¨è‡ªç¿’ Study", cost: 20 },
              { text: "æ ¡åœ’å’–å•¡ Campus Coffee", cost: 50 },
            ],
            "Mong Kok East æ—ºè§’æ±": [
              { text: "å•†å ´è³¼ç‰© Mall", cost: 100 },
              { text: "è¡—é“æ¼«æ­¥ Walk", cost: 50 },
            ],
            "Kwun Tong è§€å¡˜": [
              { text: "è³¼ç‰© Shopping", cost: 80 },
              { text: "ä¼‘é–’ Leisure", cost: 30 },
            ],
            "Shek Kip Mei çŸ³ç¡¤å°¾": [
              { text: "å°åº—æ¢éšª Explore", cost: 40 },
              { text: "é›¢é–‹ Leave", cost: 20 },
            ],
            "Sheung Wan ä¸Šç’°": [
              { text: "æ–‡é’å’–å•¡ Cafe", cost: 70 },
              { text: "è·¯é Pass By", cost: 50 },
            ],
            "Sunny Bay æ¬£æ¾³": [
              { text: "è¿ªå£«å°¼éŠç© Disney Visit", cost: 50 },
              { text: "åœ¨é™„è¿‘æ•£æ­¥ Walk", cost: 20 },
            ],
            "Hang Hau å‘å£": [
              { text: "å•†å ´é€›è¡— Mall", cost: 60 },
              { text: "å›å®¶ Home", cost: 30 },
            ],
          };

          // ç§»é™¤åŸæœ¬çš„å¹¸é‹ç«™é»äº‹ä»¶

          // èª¿æ•´äº‹ä»¶æ¦‚ç‡ï¼šå¥½äº‹ä»¶:å£äº‹ä»¶ = 4:6ï¼Œç¸½é«”è§¸ç™¼ç‡ 60%
          const trigger = Math.random();
          if (trigger < 0.6) {
            // 60% æ©Ÿç‡è§¸ç™¼äº‹ä»¶
            // åœ¨è§¸ç™¼äº‹ä»¶æ™‚ï¼Œæœ‰ 30% æ©Ÿç‡è·³å‡ºç†è²¡å•ç­”
            const quizChance = Math.random();
            if (quizChance < 0.3) {
              // 30% æ©Ÿç‡è§¸ç™¼ç†è²¡å•ç­”
              this.showFinanceQuiz();
            } else {
              const isGoodEvent = Math.random() < 0.4; // 40% æ©Ÿç‡æ˜¯å¥½äº‹ä»¶
              const events = isGoodEvent ? this.goodEvents : this.badEvents;
              const event = events[Math.floor(Math.random() * events.length)];

              // è™•ç†æŠ•è³‡ç›¸é—œäº‹ä»¶ï¼ˆå°‡è³‡ç”¢æ›´æ–°åˆ° assetsï¼‰
              if (event.effect && event.effect.investmentReturn) {
                if (this.player.investment > 0) {
                  const returnRate = event.effect.investmentReturn;
                  const profit = Math.floor(
                    this.player.investment * (returnRate - 1)
                  );
                  // ä¸ç›´æ¥æ”¹è®Š assetsï¼Œé€é effect è®“ applyEffect çµ±ä¸€è™•ç†ï¼Œé¿å…é‡è¤‡è¨ˆç®—
                  event.message += `\næŠ•è³‡${
                    returnRate > 1 ? "æ”¶ç›Š" : "æå¤±"
                  }ï¼š$${Math.abs(profit)}`;
                  this.showEvent(event.title, event.message, [], {
                    cash: profit,
                  });
                } else {
                  // å¦‚æœæ²’æœ‰æŠ•è³‡ï¼Œæ”¹ç”¨ä¸€èˆ¬äº‹ä»¶
                  const defaultEvents = isGoodEvent
                    ? this.goodEvents.filter(
                        (e) => !e.effect || !e.effect.investmentReturn
                      )
                    : this.badEvents.filter(
                        (e) => !e.effect || !e.effect.investmentReturn
                      );
                  const defaultEvent =
                    defaultEvents[
                      Math.floor(Math.random() * defaultEvents.length)
                    ];
                  this.showEvent(
                    defaultEvent.title,
                    defaultEvent.message,
                    [],
                    defaultEvent.effect
                  );
                }
              } else {
                // ä¸€èˆ¬äº‹ä»¶ç›´æ¥é¡¯ç¤º
                this.showEvent(event.title, event.message, [], event.effect);
              }
            }
          }

          // æŒ‡å®šå…è¨±æŠ•è³‡çš„ç«™é»æ¸…å–®ï¼ˆç”±ä½¿ç”¨è€…éœ€æ±‚æä¾›ï¼‰
          const investmentStations = new Set([
            "Tsuen Wan West èƒç£è¥¿",
            "Shek Mun çŸ³é–€",
            "Tsing Yi é’è¡£",
            "Kowloon ä¹é¾", // è¡¨ç¤ºä¹é¾ç«™ / ä¹é¾
            "Tai Wo Hau å¤§çª©å£",
            "Jordan ä½æ•¦",
            "Fanling ç²‰å¶º",
            "Exhibition Centre æœƒå±•",
            "Whampoa é»ƒåŸ”",
            "Kowloon Bay ä¹é¾ç£",
            "Sai Ying Pun è¥¿ç‡Ÿç›¤",
            "Fortress Hill ç‚®å°å±±",
            "Po Lam å¯¶ç³",
          ]);

          // è‹¥æ˜¯ç‰¹æ®Šç«™é»æˆ–å…è¨±æŠ•è³‡çš„ç«™é»ï¼Œé¡¯ç¤ºå¯é¸é …ç›®
          if (specialEvents[station] || investmentStations.has(station)) {
            const choices = (specialEvents[station] || []).map((choice) => ({
              text: `${choice.text} - $${choice.cost}`,
              action: () => {
                const cost = Math.floor(
                  choice.cost * (this.priceIndex[this.player.line] || 1)
                );
                this.player.assets -= cost;
                this.showMessage(`èŠ±è²»ï¼š$${cost}`);
                this.updateDisplay();
              },
            }));

            if (investmentStations.has(station)) {
              // æŠ•è³‡é¸é …ï¼š$200ã€$100ã€æˆ–ä¸æŠ•è³‡
              const invest200 = {
                text: "æŠ•è³‡ $200",
                action: () => {
                  if (this.player.assets >= 200) {
                    this.player.assets -= 200;
                    this.player.investment += 200;
                    this.player.lastInvestmentDay = this.currentDay;
                    this.showMessage(
                      "ä½ æŠ•è³‡äº† $200ã€‚æŠ•è³‡å¯èƒ½å¸¶ä¾†æ”¶ç›Šæˆ–æå¤±ã€‚æº–å‚™å¥½è¿æ¥å¸‚å ´æ³¢å‹•å§ï¼"
                    );
                    this.updateDisplay();
                  } else {
                    this.showMessage("ä½ çš„è³‡é‡‘ä¸è¶³ï¼");
                  }
                },
              };

              const invest100 = {
                text: "æŠ•è³‡ $100",
                action: () => {
                  if (this.player.assets >= 100) {
                    this.player.assets -= 100;
                    this.player.investment += 100;
                    this.player.lastInvestmentDay = this.currentDay;
                    this.showMessage(
                      "ä½ æŠ•è³‡äº† $100ã€‚æŠ•è³‡å¯èƒ½å¸¶ä¾†æ”¶ç›Šæˆ–æå¤±ã€‚æº–å‚™å¥½è¿æ¥å¸‚å ´æ³¢å‹•å§ï¼"
                    );
                    this.updateDisplay();
                  } else {
                    this.showMessage("ä½ çš„è³‡é‡‘ä¸è¶³ï¼");
                  }
                },
              };

              const noInvest = {
                text: "ä¸æŠ•è³‡",
                action: () => {
                  this.showMessage("ä½ é¸æ“‡ä¸æŠ•è³‡ã€‚");
                },
              };

              choices.push(invest200, invest100, noInvest);
            }

            // è‹¥æ²’æœ‰é¸é …æ™‚ä¸é¡¯ç¤º
            if (choices.length > 0) {
              this.showEvent(
                `ğŸ¯ ç‰¹åˆ¥åœ°é» ${station}`,
                `ä½ ä¾†åˆ° ${station}ï¼Œé¸æ“‡ä¸€é …æ´»å‹•ï¼š`,
                choices
              );
            }
          }
        }

        showFinanceQuiz() {
          const question =
            this.financeQuestions[
              Math.floor(Math.random() * this.financeQuestions.length)
            ];
          this.showEvent("ğŸ’¡ Financial Quiz ç†è²¡å•ç­”", question.question, [
            {
              text: "Yes æ˜¯",
              action: () => {
                if (question.correct) {
                  this.showMessage(
                    `Correct! ${question.explanation}\nYou move forward!\nç­”å°äº†ï¼${question.explanation}\nä½ å‰é€²ä¸€æ­¥ï¼`
                  );
                  // ç­”å°å‰é€²ä¸€æ­¥
                  this.moveToNextStation();
                } else {
                  this.showMessage(
                    `Wrong! ${question.explanation}\nYou move back!\nç­”éŒ¯äº†ï¼${question.explanation}\nä½ å¾Œé€€ä¸€æ­¥ï¼`
                  );
                  // ç­”éŒ¯å¾Œé€€ä¸€æ­¥
                  this.moveBackStation();
                }
                this.updateDisplay();
              },
            },
            {
              text: "No å¦",
              action: () => {
                if (!question.correct) {
                  this.showMessage(
                    `Correct! ${question.explanation}\nYou move forward!\nç­”å°äº†ï¼${question.explanation}\nä½ å‰é€²ä¸€æ­¥ï¼`
                  );
                  // ç­”å°å‰é€²ä¸€æ­¥
                  this.moveToNextStation();
                } else {
                  this.showMessage(
                    `Wrong! ${question.explanation}\nYou move back!\nç­”éŒ¯äº†ï¼${question.explanation}\nä½ å¾Œé€€ä¸€æ­¥ï¼`
                  );
                  // ç­”éŒ¯å¾Œé€€ä¸€æ­¥
                  this.moveBackStation();
                }
                this.updateDisplay();
              },
            },
          ]);
        }

        showEvent(title, message, choices = [], effect = null) {
          const modal = document.getElementById("eventModal");
          const emoji = document.getElementById("eventEmoji");
          const titleEl = document.getElementById("eventTitle");
          const messageEl = document.getElementById("eventMessage");
          const choicesEl = document.getElementById("eventChoices");

          // è¨­ç½®äº‹ä»¶å…§å®¹
          emoji.textContent = title.includes("Lucky")
            ? "ğŸ€"
            : title.includes("Quiz")
            ? "ğŸ’¡"
            : title.includes("Scam")
            ? "ğŸš¨"
            : "ğŸ¯";
          titleEl.textContent = title;
          messageEl.textContent = message;

          // æ¸…ç©ºé¸æ“‡æŒ‰éˆ•
          choicesEl.innerHTML = "";

          // æ·»åŠ é¸æ“‡æŒ‰éˆ•
          choices.forEach((choice) => {
            const button = document.createElement("button");
            button.className = "choice-btn primary";
            button.textContent = choice.text;
            button.onclick = () => {
              choice.action();
              modal.classList.remove("active");
            };
            choicesEl.appendChild(button);
          });

          // å¦‚æœæ²’æœ‰é¸æ“‡ï¼Œæ·»åŠ ç¢ºå®šæŒ‰éˆ•
          if (choices.length === 0) {
            const confirmBtn = document.createElement("button");
            confirmBtn.className = "choice-btn primary";
            confirmBtn.textContent = "OK ç¢ºå®š";
            confirmBtn.onclick = () => {
              if (effect) {
                this.applyEffect(effect);
              }
              modal.classList.remove("active");
            };
            choicesEl.appendChild(confirmBtn);
          }

          // é¡¯ç¤ºå½ˆçª—
          modal.classList.add("active");
        }

        applyEffect(effect) {
          if (effect.cash) {
            this.player.assets += effect.cash;
            // å¦‚æœæ˜¯æ­£å‘ç²å¾—ï¼ŒåŠ å…¥åˆ°ç´¯ç©ç²å¾—
            if (effect.cash > 0) {
              this.player.cumulativeGains += effect.cash;
            }
            this.showMessage(
              `${effect.cash > 0 ? "Gained" : "Lost"} $${Math.abs(
                effect.cash
              )}!\n${effect.cash > 0 ? "ç²å¾—" : "æå¤±"}$${Math.abs(
                effect.cash
              )}ï¼`
            );
          }
          if (effect.moveBack) {
            this.moveBackStation();
            this.showMessage(
              "You moved back one station due to typhoon delay!\nå› é¢±é¢¨å»¶èª¤ï¼Œä½ å¾Œé€€äº†ä¸€æ­¥ï¼"
            );
          }
          this.updateDisplay();
        }

        showMessage(message) {
          alert(message);
        }

        updateDisplay() {
          // æ›´æ–°é ­éƒ¨ä¿¡æ¯
          document.getElementById("displayNickname").textContent =
            this.player.name;
          document.getElementById("displayStudentId").textContent =
            this.studentId;
          document.getElementById("currentDay").textContent = this.currentDay;
          document.getElementById("currentDate").textContent = this.formatDate(
            this.currentDate
          );
          document.getElementById("currentStation").textContent = `${
            this.player.currentStation
          } (${this.getLineName(this.player.line)})`;
          // ç¸½è³‡ç”¢å®šç¾©ç‚ºï¼šç›®å‰æŒæœ‰ç¾é‡‘ + ç›®å‰æŠ•è³‡é‡‘é¡ + ç´¯ç©å„²è“„
          const currentCash = this.player.assets || 0;
          const totalInvestment = this.player.investment || 0;
          const totalSavings = this.player.totalSavings || 0;
          const computedTotalAssets =
            currentCash + totalInvestment + totalSavings;
          document.getElementById("totalAssets").textContent =
            computedTotalAssets.toLocaleString();
          document.getElementById("dailySavings").textContent = this.currentDay;

          // æ›´æ–°ç©å®¶è³‡è¨Šé¢æ¿
          document.getElementById(
            "infoTotalAssets"
          ).textContent = `$${computedTotalAssets.toLocaleString()}`;
          document.getElementById(
            "infoCurrentDay"
          ).textContent = `ç¬¬ ${this.currentDay} å¤©`;
          document.getElementById("infoCurrentStation").textContent =
            this.player.currentStation;
          document.getElementById("infoPriceIndex").textContent = (
            this.priceIndex[this.player.line] || 1
          ).toFixed(3);
          document.getElementById(
            "infoDailySavings"
          ).textContent = `$${this.currentDay}`;
          document.getElementById(
            "infoTotalSavings"
          ).textContent = `$${this.player.totalSavings.toLocaleString()}`;
          // é¡¯ç¤ºç¸½æŠ•è³‡
          document.getElementById(
            "infoTotalInvestment"
          ).textContent = `$${totalInvestment.toLocaleString()}`;
          // é¡¯ç¤ºç´¯ç©ç²å¾—
          document.getElementById("infoCumulativeGains").textContent = `$${(
            this.player.cumulativeGains || 0
          ).toLocaleString()}`;
        }

        drawGameBoard() {
          const mapContainer = document.getElementById("railway-map");
          mapContainer.innerHTML = "";

          // å»ºç«‹ä¸€å€‹ SVG ä½œç‚ºç·šæ®µç¹ªè£½çš„ç•«å¸ƒ
          const svgNS = "http://www.w3.org/2000/svg";
          const svg = document.createElementNS(svgNS, "svg");
          svg.setAttribute("class", "rail-lines-svg");
          svg.setAttribute("width", "100%");
          svg.setAttribute("height", "100%");
          svg.style.position = "absolute";
          svg.style.left = "0";
          svg.style.top = "0";
          svg.style.zIndex = "1";

          // ç¹ªè£½è»Šç«™æ¨™è¨˜å®¹å™¨ (ç½®æ–¼ SVG ä¹‹ä¸Š)
          const stationsDiv = document.createElement("div");
          stationsDiv.className = "stations";

          // å¹«åŠ©å‡½æ•¸: å¾ç™¾åˆ†æ¯”åº§æ¨™æ›ç®—åˆ°åƒç´ ä½ç½® (ç›¸å°æ–¼ mapContainer)
          const getPixelPos = (pctX, pctY) => {
            const rect = mapContainer.getBoundingClientRect();
            const x = (pctX / 100) * rect.width;
            const y = (pctY / 100) * rect.height;
            return { x, y };
          };

          // å…ˆç¹ªè£½æ‰€æœ‰ station å…ƒç´ ï¼ˆä»¥ä¾¿ä¹‹å¾Œå¯ç”¨ name æŸ¥æ‰¾ï¼‰
          Object.entries(gameBoard.stations).forEach(([name, info]) => {
            const station = document.createElement("div");
            station.className = `station-marker ${
              name === this.player.currentStation ? "current" : ""
            }`;
            station.style.left = `${info.x}%`;
            station.style.top = `${info.y}%`;
            station.innerHTML = `
                        <div class="station-dot"></div>
                        <div class="station-name">${name}</div>
                    `;
            stationsDiv.appendChild(station);
          });

          // ç¹ªè£½ç·šæ®µ (ä½¿ç”¨ SVG lineï¼Œæ¡ç”¨åƒç´ åº§æ¨™ä»¥ç¢ºä¿ç²¾æº–é•·åº¦)
          gameBoard.connections.forEach((conn) => {
            const fromStation = gameBoard.getStation(conn.from);
            const toStation = gameBoard.getStation(conn.to);

            if (fromStation && toStation) {
              const p1 = getPixelPos(fromStation.x, fromStation.y);
              const p2 = getPixelPos(toStation.x, toStation.y);

              const line = document.createElementNS(svgNS, "line");
              line.setAttribute("x1", p1.x);
              line.setAttribute("y1", p1.y);
              line.setAttribute("x2", p2.x);
              line.setAttribute("y2", p2.y);
              line.setAttribute(
                "stroke",
                gameBoard.lineColors[conn.line] || "#666"
              );
              line.setAttribute("stroke-width", 8);
              line.setAttribute("stroke-linecap", "round");
              line.style.transition = "opacity 0.3s ease";

              svg.appendChild(line);
            }
          });

          mapContainer.appendChild(svg);
          mapContainer.appendChild(stationsDiv);
        }

        showPlayerAtStation(stationName) {
          const playerIcon = document.getElementById("player-icon");
          const station = gameBoard.getStation(stationName);

          if (station && playerIcon) {
            playerIcon.style.left = `${station.x}%`;
            playerIcon.style.top = `${station.y}%`;
            playerIcon.style.display = "block";

            // æ›´æ–°è»Šç«™æ¨™è¨˜
            document.querySelectorAll(".station-marker").forEach((marker) => {
              marker.classList.remove("current");
            });
            document.querySelectorAll(".station-marker").forEach((marker) => {
              if (
                marker.querySelector(".station-name").textContent ===
                stationName
              ) {
                marker.classList.add("current");
              }
            });
          }
        }

        // ç™¼é€éŠæˆ²æ•¸æ“šåˆ° Google Forms
        async sendGameData(status) {
          const formData = new FormData();
          formData.append("entry.1", this.studentId); // å­¸ç”ŸID
          formData.append("entry.2", this.player.name); // ç©å®¶æš±ç¨±
          formData.append("entry.3", status); // éŠæˆ²ç‹€æ…‹ï¼ˆå‹åˆ©/çµæŸï¼‰
          formData.append("entry.4", this.currentDay.toString()); // éŠæˆ²å¤©æ•¸
          formData.append("entry.5", this.player.totalSavings.toString()); // ç¸½å„²è“„
          formData.append("entry.6", this.player.investment.toString()); // ç¸½æŠ•è³‡
          formData.append("entry.7", this.player.assets.toString()); // ç•¶å‰è³‡ç”¢
          formData.append("entry.8", new Date().toISOString()); // éŠæˆ²æ™‚é–“

          try {
            // é€™è£¡éœ€è¦æ›¿æ›ç‚ºä½ çš„ Google Forms URL
            const response = await fetch("YOUR_GOOGLE_FORM_URL", {
              method: "POST",
              mode: "no-cors",
              body: formData,
            });
            console.log("Data sent successfully");
          } catch (error) {
            console.error("Error sending data:", error);
          }
        }

        showVictory() {
          // ç™¼é€å‹åˆ©æ•¸æ“š
          this.sendGameData("victory");

          this.showEvent(
            "ğŸ‰ æ­å–œï¼",
            `æ­å–œï¼Œæ‚¨æˆåŠŸå„²åˆ°ä½ çš„ç¬¬ä¸€æ¡¶é‡‘ $10,000ï¼ğŸ‰\n\néŠæˆ²å¤©æ•¸ï¼šç¬¬ ${this.currentDay} å¤©\nç´¯ç©å„²è“„ï¼š$${this.player.totalSavings}\nç›®å‰è³‡ç”¢ï¼š$${this.player.assets}`,
            [
              {
                text: "Play Again å†ç©ä¸€æ¬¡",
                action: () => location.reload(),
              },
            ]
          );
        }

        showGameOver() {
          // ç™¼é€éŠæˆ²çµæŸæ•¸æ“š
          this.sendGameData("gameover");

          this.showEvent(
            "â° Game Over éŠæˆ²çµæŸ",
            `365 days have passed! Your final assets: $${this.player.assets}\n365å¤©éå»äº†ï¼ä½ çš„æœ€çµ‚è³‡ç”¢ï¼š$${this.player.assets}\nTotal Savings ç¸½å„²è“„: $${this.player.totalSavings}`,
            [
              {
                text: "Play Again å†ç©ä¸€æ¬¡",
                action: () => location.reload(),
              },
            ]
          );
        }
      }

      // éŠæˆ²åˆå§‹åŒ–
      let game;

      document.getElementById("startGameBtn").onclick = function () {
        const studentId = document.getElementById("studentId").value.trim();
        const nickname = document.getElementById("playerNickname").value.trim();

        if (!studentId || !nickname) {
          alert("Please fill in all information! è«‹å¡«å¯«æ‰€æœ‰ä¿¡æ¯ï¼");
          return;
        }

        // åˆ‡æ›åˆ°éŠæˆ²é é¢
        document.getElementById("login-page").classList.remove("active");
        document.getElementById("game-page").classList.add("active");

        // åˆå§‹åŒ–éŠæˆ²
        game = new FinanceGame(studentId, nickname);
      };

      document.getElementById("nextDayBtn").onclick = function () {
        if (game) {
          game.nextDay();
        }
      };

      document.getElementById("newGameBtn").onclick = function () {
        location.reload();
      };

      // é—œé–‰äº‹ä»¶å½ˆçª—çš„é»æ“Šäº‹ä»¶
      document.getElementById("eventModal").onclick = function (e) {
        if (e.target === this) {
          this.classList.remove("active");
        }
      };
    </script>
  </body>
</html>
